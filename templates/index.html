
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RetroArch Analysis Stream</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <button
      class="floating-action"
      type="button"
      aria-label="External information"
      title="External information"
    >
      <img
        src="data:image/png;base64,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"
        alt="external information"
      />
    </button>
    <main>
      <header class="page-header">
        <h1>RetroArch Analysis Stream</h1>
        <p>Live Pokémon battle analyses and summaries generated by the capture loop.</p>
      </header>

      <section class="panel">
        <div class="panel-heading">
          <h2>Frame Analyses</h2>
          <span id="analysis-status" class="status-pill">Connecting…</span>
        </div>
        <div id="analysis-stream" class="stream"></div>
      </section>

      <section class="panel">
        <div class="panel-heading">
          <h2>Summaries</h2>
          <span id="summary-status" class="status-pill">Connecting…</span>
        </div>
        <div id="summary-stream" class="stream"></div>
      </section>
    </main>

    <script>
      const analysisContainer = document.getElementById('analysis-stream');
      const summaryContainer = document.getElementById('summary-stream');
      const analysisStatus = document.getElementById('analysis-status');
      const summaryStatus = document.getElementById('summary-status');

      function trimChildren(container, limit = 50) {
        while (container.children.length > limit) {
          container.removeChild(container.lastChild);
        }
      }

      function containerFor(url) {
        return url.includes('summary') ? summaryContainer : analysisContainer;
      }

      function setStatus(statusEl, text, tone) {
        statusEl.textContent = text;
        statusEl.dataset.tone = tone;
      }

      function attachStream(url, handler, statusEl) {
        const source = new EventSource(url);
        source.onmessage = handler;
        source.onopen = () => setStatus(statusEl, 'Connected', 'ok');
        source.onerror = () => setStatus(statusEl, 'Reconnecting…', 'warn');
        return source;
      }

      function renderAnalysis(event) {
        const payload = JSON.parse(event.data);
        const item = document.createElement('article');
        item.className = 'stream-item';

        const header = document.createElement('div');
        header.className = 'stream-header';
        const badge = document.createElement('span');
        badge.className = 'badge';

        if (payload.type === 'analysis') {
          badge.textContent = `Frame ${payload.capture_index ?? '?'}`;
          header.appendChild(badge);
          const ts = document.createElement('span');
          ts.textContent = payload.timestamp || '';
          header.appendChild(ts);
          item.appendChild(header);

          const statusLine = document.createElement('p');
          statusLine.className = 'status-line';
          const battleStatus = payload.meta && payload.meta.battle_detected ? 'Battle detected' : 'Not a battle';
          const toolStatus = payload.meta && payload.meta.tool_called ? 'PokéAPI call complete' : 'No tool calls';
          statusLine.textContent = `${battleStatus} • ${toolStatus}`;
          item.appendChild(statusLine);

          if (payload.meta && payload.meta.participants && payload.meta.participants.length) {
            const participants = document.createElement('p');
            participants.className = 'participants';
            participants.textContent = `Participants: ${payload.meta.participants.join(' vs. ')}`;
            item.appendChild(participants);
          }

          const jsonBlock = document.createElement('pre');
          jsonBlock.textContent = JSON.stringify(payload.data, null, 2);
          item.appendChild(jsonBlock);
        } else if (payload.type === 'analysis_error') {
          badge.textContent = 'Error';
          badge.classList.add('error');
          header.appendChild(badge);
          const ts = document.createElement('span');
          ts.textContent = payload.timestamp || '';
          header.appendChild(ts);
          item.appendChild(header);

          const message = document.createElement('p');
          message.className = 'status-line';
          message.textContent = payload.message || 'Analysis error';
          item.appendChild(message);

          if (payload.raw) {
            const rawBlock = document.createElement('pre');
            rawBlock.textContent = payload.raw;
            item.appendChild(rawBlock);
          }

          item.classList.add('error');
        }

        analysisContainer.prepend(item);
        trimChildren(analysisContainer);
      }

      function renderSummary(event) {
        const payload = JSON.parse(event.data);
        const item = document.createElement('article');
        item.className = 'stream-item summary';

        const header = document.createElement('div');
        header.className = 'stream-header';
        const badge = document.createElement('span');
        badge.className = 'badge summary';
        badge.textContent = 'Summary';
        header.appendChild(badge);
        const ts = document.createElement('span');
        ts.textContent = payload.timestamp || '';
        header.appendChild(ts);
        item.appendChild(header);

        const body = document.createElement('p');
        body.textContent = payload.summary || '';
        item.appendChild(body);

        summaryContainer.prepend(item);
        trimChildren(summaryContainer, 20);
      }

      attachStream('/stream/analysis', renderAnalysis, analysisStatus);
      attachStream('/stream/summaries', renderSummary, summaryStatus);
    </script>
  </body>
</html>
