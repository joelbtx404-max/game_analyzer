
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RetroArch Analysis Stream</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <main>
      <header class="page-header">
        <h1>RetroArch Analysis Stream</h1>
        <p>Live Pokémon battle analyses and summaries generated by the capture loop.</p>
      </header>

      <section class="panel">
        <div class="panel-heading">
          <h2>Frame Analyses</h2>
          <span id="analysis-status" class="status-pill">Connecting…</span>
        </div>
        <div id="analysis-stream" class="stream"></div>
      </section>

      <section class="panel">
        <div class="panel-heading">
          <h2>Summaries</h2>
          <span id="summary-status" class="status-pill">Connecting…</span>
        </div>
        <div id="summary-stream" class="stream"></div>
      </section>
    </main>

    <script>
      const analysisContainer = document.getElementById('analysis-stream');
      const summaryContainer = document.getElementById('summary-stream');
      const analysisStatus = document.getElementById('analysis-status');
      const summaryStatus = document.getElementById('summary-status');

      function trimChildren(container, limit = 50) {
        while (container.children.length > limit) {
          container.removeChild(container.lastChild);
        }
      }

      function containerFor(url) {
        return url.includes('summary') ? summaryContainer : analysisContainer;
      }

      function setStatus(statusEl, text, tone) {
        statusEl.textContent = text;
        statusEl.dataset.tone = tone;
      }

      function attachStream(url, handler, statusEl) {
        const source = new EventSource(url);
        source.onmessage = handler;
        source.onopen = () => setStatus(statusEl, 'Connected', 'ok');
        source.onerror = () => setStatus(statusEl, 'Reconnecting…', 'warn');
        return source;
      }

      function renderAnalysis(event) {
        const payload = JSON.parse(event.data);
        const item = document.createElement('article');
        item.className = 'stream-item';

        const header = document.createElement('div');
        header.className = 'stream-header';
        const badge = document.createElement('span');
        badge.className = 'badge';

        if (payload.type === 'analysis') {
          badge.textContent = `Frame ${payload.capture_index ?? '?'}`;
          header.appendChild(badge);
          const ts = document.createElement('span');
          ts.textContent = payload.timestamp || '';
          header.appendChild(ts);
          item.appendChild(header);

          const statusLine = document.createElement('p');
          statusLine.className = 'status-line';
          const battleStatus = payload.meta && payload.meta.battle_detected ? 'Battle detected' : 'Not a battle';
          const toolStatus = payload.meta && payload.meta.tool_called ? 'PokéAPI call complete' : 'No tool calls';
          statusLine.textContent = `${battleStatus} • ${toolStatus}`;
          item.appendChild(statusLine);

          if (payload.meta && payload.meta.participants && payload.meta.participants.length) {
            const participants = document.createElement('p');
            participants.className = 'participants';
            participants.textContent = `Participants: ${payload.meta.participants.join(' vs. ')}`;
            item.appendChild(participants);
          }

          const jsonBlock = document.createElement('pre');
          jsonBlock.textContent = JSON.stringify(payload.data, null, 2);
          item.appendChild(jsonBlock);
        } else if (payload.type === 'analysis_error') {
          badge.textContent = 'Error';
          badge.classList.add('error');
          header.appendChild(badge);
          const ts = document.createElement('span');
          ts.textContent = payload.timestamp || '';
          header.appendChild(ts);
          item.appendChild(header);

          const message = document.createElement('p');
          message.className = 'status-line';
          message.textContent = payload.message || 'Analysis error';
          item.appendChild(message);

          if (payload.raw) {
            const rawBlock = document.createElement('pre');
            rawBlock.textContent = payload.raw;
            item.appendChild(rawBlock);
          }

          item.classList.add('error');
        }

        analysisContainer.prepend(item);
        trimChildren(analysisContainer);
      }

      function renderSummary(event) {
        const payload = JSON.parse(event.data);
        const item = document.createElement('article');
        item.className = 'stream-item summary';

        const header = document.createElement('div');
        header.className = 'stream-header';
        const badge = document.createElement('span');
        badge.className = 'badge summary';
        badge.textContent = 'Summary';
        header.appendChild(badge);
        const ts = document.createElement('span');
        ts.textContent = payload.timestamp || '';
        header.appendChild(ts);
        item.appendChild(header);

        const body = document.createElement('p');
        body.textContent = payload.summary || '';
        item.appendChild(body);

        summaryContainer.prepend(item);
        trimChildren(summaryContainer, 20);
      }

      attachStream('/stream/analysis', renderAnalysis, analysisStatus);
      attachStream('/stream/summaries', renderSummary, summaryStatus);
    </script>
  </body>
</html>
